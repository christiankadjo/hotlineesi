<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>Hotline ESI</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="dist/phaser.js"></script>
    <style type="text/css">
    body{
        margin:0;
    }
    </style>
</head>
<body>
    <script>
        const PLAYER_SPEED = 320;
        const PROJECTILE_SPEED = 600;
        const FIRERATE = 100;

        var config = {
            type: Phaser.Auto,
            width:800,
            height:600,
            physics:{
                default:'arcade',
                arcade: {

                }
            },
            scene:{
                preload:preload,
                create: create,
                update: update
            }
        };
        var game = new Phaser.Game(config);
        var cube;
        var bullets;
        var client = {};
        var nextFire = 0;

        var textDebug;

        function preload()
        {
            this.load.image('floor', 'assets/floor.png');
            this.load.spritesheet('cube', 'assets/cube.png', {frameWidth:40, frameHeight:40});
            this.load.image('bullet', 'assets/bullet.png');
        }

        function create()
        {
            client.socket = io.connect();
            this.add.image(400,300,'floor');
            cube = this.physics.add.sprite(400,300,'cube');
            cube.setCollideWorldBounds(true);
            cube.body.allowRotation = false;

            //  bullets = this.physics.add.group({
            //      defaultKey:'bullet',
            //      maxSize:5
            //  });

            bullets = new BulletGroup(this);
            this.input.setDefaultCursor('url(assets/crosshair.png), pointer');

            text = this.add.text(10, 10, 'Debug', { font: '16px Courier', fill: '#00ff00' });

        }

        function update()
        {
            var angle =0;
            // cube.rotation = this.physics.arcade.angleToPointer(cube);
            var cursors = this.input.keyboard.createCursorKeys();

            playerMovement(cursors);

            this.input.on('pointermove',function(pointer){
                angle = Phaser.Math.RAD_TO_DEG * Phaser.Math.Angle.BetweenPoints(cube, pointer);
                cube.setAngle(angle);
            }, this);


            this.input.on('pointerdown', pointer => {
                if(game.getTime()> nextFire)
                {
                    nextFire = game.getTime() + FIRERATE;
                    var bullet = bullets.getFirstDead(false); //getFirstDead will get the first child of the group that is considered dead... ie: The .alive property is false...
                    if(bullet){
                        bullet.shoot(cube.x,cube.y);
                        this.physics.velocityFromAngle(angle, PROJECTILE_SPEED, bullet.body.velocity);
                    }
                }
            }, this);

            //DEBUG
            text.setText([
                'getTime: ' + game.getTime(),
                'nextFire: ' + nextFire
            ]);
            
        }


        function playerMovement(cursors)
        {
            if(cursors.left.isDown)
            {
                cube.setVelocityX(-PLAYER_SPEED);
            }
            else if(cursors.right.isDown)
            {
                cube.setVelocityX(PLAYER_SPEED);
            }
            else {
                cube.setVelocityX(0);
            } 
            
            
            if(cursors.up.isDown)
            {
                cube.setVelocityY(-PLAYER_SPEED);
            }
            else if(cursors.down.isDown)
            {
                cube.setVelocityY(PLAYER_SPEED);
            }
            else
            {
                cube.setVelocityY(0);
            }
        }

        class BulletGroup extends Phaser.Physics.Arcade.Group {
            constructor(scene)
            {
                // Call the super constructor, passing in a world and a scene
                super(scene.physics.world, scene);

                // Initialize the group
                this.createMultiple({
                    classType:Bullet,
                    frameQuantity: 10, //create 10 instances
                    active: false,
                    visible:false,
                    key:'bullet'
                });
            }
        }

        class Bullet extends Phaser.Physics.Arcade.Sprite{
            constructor(scene, x, y) {
                super(scene, x, y, 'bullet');
            }

            shoot(x,y)
            {
                this.body.reset(x,y);
                this.setActive(true);
                this.setVisible(true);
            }
        }
    </script>
</body>
</html>
